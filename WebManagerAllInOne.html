<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Intercambio de Regalos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to top, rgba(194, 65, 12, 0.15) 0%, transparent 100%);
            z-index: 0;
            pointer-events: none;
        }
        
        .christmas-city {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            z-index: 1;
            pointer-events: none;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: 0 5%;
            opacity: 0.3;
        }
        
        .building {
            display: flex;
            flex-direction: column;
            align-items: center;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .building-body {
            background: linear-gradient(135deg, #92400e 0%, #c2410c 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
        }
        
        .building-windows {
            position: absolute;
            top: 10%;
            left: 0;
            right: 0;
            height: 80%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 5px;
        }
        
        .window-row {
            display: flex;
            justify-content: space-around;
        }
        
        .window {
            width: 8px;
            height: 8px;
            background: #fbbf24;
            border-radius: 1px;
            box-shadow: 0 0 5px #fbbf24;
        }
        
        .forest {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25%;
            z-index: 2;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            opacity: 0.4;
            padding: 0 2%;
        }
        
        .tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 -10px;
        }
        
        .tree-top {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 35px solid #065f46;
            position: relative;
        }
        
        .tree-top::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -20px;
            width: 40px;
            height: 12px;
            background: white;
            border-radius: 50%;
            opacity: 0.9;
        }
        
        .tree-middle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 40px solid #047857;
            margin-top: -15px;
            position: relative;
        }
        
        .tree-middle::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -25px;
            width: 50px;
            height: 10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .tree-bottom {
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 45px solid #059669;
            margin-top: -15px;
            position: relative;
        }
        
        .tree-bottom::after {
            content: '';
            position: absolute;
            top: 0px;
            left: -30px;
            width: 60px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
        }
        
        .tree-trunk {
            width: 10px;
            height: 15px;
            background: #78350f;
            margin-top: -5px;
        }
        
        .tree.small .tree-top {
            border-left-width: 12px;
            border-right-width: 12px;
            border-bottom-width: 20px;
        }
        
        .tree.small .tree-top::after {
            width: 24px;
            left: -12px;
            height: 8px;
        }
        
        .tree.small .tree-middle {
            border-left-width: 15px;
            border-right-width: 15px;
            border-bottom-width: 25px;
        }
        
        .tree.small .tree-middle::after {
            width: 30px;
            left: -15px;
            height: 6px;
        }
        
        .tree.small .tree-bottom {
            border-left-width: 18px;
            border-right-width: 18px;
            border-bottom-width: 30px;
        }
        
        .tree.small .tree-bottom::after {
            width: 36px;
            left: -18px;
            height: 5px;
        }
        
        .tree.small .tree-trunk {
            width: 6px;
            height: 10px;
        }
        
        .tree.large .tree-top {
            border-left-width: 28px;
            border-right-width: 28px;
            border-bottom-width: 50px;
        }
        
        .tree.large .tree-top::after {
            width: 56px;
            left: -28px;
            height: 15px;
        }
        
        .tree.large .tree-middle {
            border-left-width: 35px;
            border-right-width: 35px;
            border-bottom-width: 60px;
        }
        
        .tree.large .tree-middle::after {
            width: 70px;
            left: -35px;
            height: 12px;
        }
        
        .tree.large .tree-bottom {
            border-left-width: 42px;
            border-right-width: 42px;
            border-bottom-width: 70px;
        }
        
        .tree.large .tree-bottom::after {
            width: 84px;
            left: -42px;
            height: 10px;
        }
        
        .tree.large .tree-trunk {
            width: 14px;
            height: 20px;
        }
        
        .garland-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            z-index: 3;
            pointer-events: none;
            overflow: visible;
        }
        
        .garland-strand {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
        }
        
        .garland-branch {
            position: absolute;
            width: 8px;
            background: linear-gradient(180deg, #065f46 0%, #047857 50%, #059669 100%);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .garland-branch::before,
        .garland-branch::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 3px;
            background: #065f46;
            border-radius: 2px;
        }
        
        .garland-branch::before {
            top: 20%;
            left: -6px;
            transform: rotate(-30deg);
        }
        
        .garland-branch::after {
            top: 50%;
            right: -6px;
            transform: rotate(30deg);
        }
        
        .light {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        
        .light::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 8px;
            background: #1f2937;
            border-radius: 1px;
        }
        
        .light.red {
            background: radial-gradient(circle, #fca5a5 0%, #ef4444 100%);
            box-shadow: 0 0 15px #ef4444, 0 0 5px #ef4444;
        }
        
        .light.yellow {
            background: radial-gradient(circle, #fde68a 0%, #fbbf24 100%);
            box-shadow: 0 0 15px #fbbf24, 0 0 5px #fbbf24;
            animation-delay: 0.5s;
        }
        
        .light.blue {
            background: radial-gradient(circle, #93c5fd 0%, #3b82f6 100%);
            box-shadow: 0 0 15px #3b82f6, 0 0 5px #3b82f6;
            animation-delay: 1s;
        }
        
        .light.green {
            background: radial-gradient(circle, #6ee7b7 0%, #10b981 100%);
            box-shadow: 0 0 15px #10b981, 0 0 5px #10b981;
            animation-delay: 1.5s;
        }
        
        .light.pink {
            background: radial-gradient(circle, #fbcfe8 0%, #ec4899 100%);
            box-shadow: 0 0 15px #ec4899, 0 0 5px #ec4899;
            animation-delay: 0.75s;
        }
        
        .light.orange {
            background: radial-gradient(circle, #fed7aa 0%, #f97316 100%);
            box-shadow: 0 0 15px #f97316, 0 0 5px #f97316;
            animation-delay: 1.25s;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }
        
        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation: snowfall linear infinite;
            color: white;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            pointer-events: none;
        }
        
        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0.3;
            }
        }
        
        .snowflake:nth-child(1) { left: 10%; animation-duration: 8s; animation-delay: 0s; font-size: 1.2em; }
        .snowflake:nth-child(2) { left: 20%; animation-duration: 10s; animation-delay: 1s; font-size: 0.8em; }
        .snowflake:nth-child(3) { left: 30%; animation-duration: 12s; animation-delay: 2s; font-size: 1em; }
        .snowflake:nth-child(4) { left: 40%; animation-duration: 9s; animation-delay: 0.5s; font-size: 1.3em; }
        .snowflake:nth-child(5) { left: 50%; animation-duration: 11s; animation-delay: 1.5s; font-size: 0.9em; }
        .snowflake:nth-child(6) { left: 60%; animation-duration: 10s; animation-delay: 2.5s; font-size: 1.1em; }
        .snowflake:nth-child(7) { left: 70%; animation-duration: 13s; animation-delay: 0.8s; font-size: 0.85em; }
        .snowflake:nth-child(8) { left: 80%; animation-duration: 9s; animation-delay: 1.8s; font-size: 1.2em; }
        .snowflake:nth-child(9) { left: 90%; animation-duration: 11s; animation-delay: 2.2s; font-size: 0.95em; }
        .snowflake:nth-child(10) { left: 15%; animation-duration: 12s; animation-delay: 0.3s; font-size: 1em; }
        .snowflake:nth-child(11) { left: 25%; animation-duration: 10s; animation-delay: 1.2s; font-size: 0.9em; }
        .snowflake:nth-child(12) { left: 35%; animation-duration: 11s; animation-delay: 2.8s; font-size: 1.15em; }
        .snowflake:nth-child(13) { left: 45%; animation-duration: 9s; animation-delay: 0.6s; font-size: 0.85em; }
        .snowflake:nth-child(14) { left: 55%; animation-duration: 13s; animation-delay: 1.9s; font-size: 1.1em; }
        .snowflake:nth-child(15) { left: 65%; animation-duration: 10s; animation-delay: 2.3s; font-size: 0.95em; }
        .snowflake:nth-child(16) { left: 75%; animation-duration: 12s; animation-delay: 0.9s; font-size: 1.25em; }
        .snowflake:nth-child(17) { left: 85%; animation-duration: 11s; animation-delay: 1.6s; font-size: 0.88em; }
        .snowflake:nth-child(18) { left: 95%; animation-duration: 9s; animation-delay: 2.7s; font-size: 1.05em; }
        .snowflake:nth-child(19) { left: 5%; animation-duration: 10s; animation-delay: 0.4s; font-size: 0.92em; }
        .snowflake:nth-child(20) { left: 33%; animation-duration: 13s; animation-delay: 1.4s; font-size: 1.18em; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(251, 146, 60, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(251, 146, 60, 0.8);
            }
        }
        
        .dice-roll {
            animation: diceRoll 1.5s infinite;
        }
        
        @keyframes diceRoll {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
        }
        
        .admin-card {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            box-shadow: 0 25px 50px rgba(251, 146, 60, 0.5);
        }
        
        .participant-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 25px 50px rgba(59, 130, 246, 0.5);
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Sleigh Animation Styles */
        .sleigh-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .sleigh-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .sleigh {
            position: absolute;
            font-size: 5rem;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: sleighMove 4s ease-in-out infinite;
        }
        
        @keyframes sleighMove {
            0% {
                left: -10%;
                top: 15%;
                transform: rotate(-5deg) scale(1);
            }
            25% {
                left: 30%;
                top: 55%;
                transform: rotate(5deg) scale(1.1);
            }
            50% {
                left: 70%;
                top: 25%;
                transform: rotate(-3deg) scale(1);
            }
            75% {
                left: 35%;
                top: 70%;
                transform: rotate(7deg) scale(1.15);
            }
            100% {
                left: 110%;
                top: 35%;
                transform: rotate(-5deg) scale(1);
            }
        }
        
        .sleigh-message {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            padding: 2.5rem 4rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            border: 3px solid #dc2626;
            animation: messageFloat 2s ease-in-out infinite;
        }
        
        @keyframes messageFloat {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        .sleigh-message h3 {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 0.75rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .sleigh-message p {
            font-size: 1.25rem;
            color: #4b5563;
            font-weight: 500;
        }
        
        .sleigh-stars {
            position: absolute;
            font-size: 2rem;
            animation: starTwinkle 1.5s ease-in-out infinite;
        }
        
        @keyframes starTwinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .sleigh-stars:nth-child(1) { top: 10%; left: 15%; animation-delay: 0s; }
        .sleigh-stars:nth-child(2) { top: 25%; left: 80%; animation-delay: 0.3s; }
        .sleigh-stars:nth-child(3) { top: 60%; left: 10%; animation-delay: 0.6s; }
        .sleigh-stars:nth-child(4) { top: 75%; left: 85%; animation-delay: 0.9s; }
        .sleigh-stars:nth-child(5) { top: 40%; left: 50%; animation-delay: 1.2s; }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 font-sans relative"><!-- Sleigh Animation Overlay -->
  <div id="sleigh-overlay" class="sleigh-overlay hidden">
   <div class="sleigh-container">
    <div class="sleigh">
     üõ∑
    </div>
    <div class="sleigh-stars">
     ‚ú®
    </div>
    <div class="sleigh-stars">
     ‚≠ê
    </div>
    <div class="sleigh-stars">
     ‚ú®
    </div>
    <div class="sleigh-stars">
     ‚≠ê
    </div>
    <div class="sleigh-stars">
     ‚ú®
    </div>
    <div class="sleigh-message">
     <h3>üéÖ Espera un momento...</h3>
     <p id="sleigh-message-text">Realizando sorteo m√°gico...</p>
    </div>
   </div>
  </div><!-- Christmas Garland -->
  <div class="garland-container">
   <div class="garland-strand" id="garland-strand"></div>
  </div><!-- Christmas City Background -->
  <div class="christmas-city">
   <div class="building">
    <div class="text-3xl">
     ‚≠ê
    </div>
    <div class="building-body" style="width: 60px; height: 120px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="building">
    <div class="text-2xl">
     üéÑ
    </div>
    <div class="building-body" style="width: 50px; height: 90px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="building">
    <div class="text-3xl">
     ‚ú®
    </div>
    <div class="building-body" style="width: 70px; height: 140px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="building">
    <div class="text-2xl">
     üåü
    </div>
    <div class="building-body" style="width: 55px; height: 100px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="building">
    <div class="text-3xl">
     üéÑ
    </div>
    <div class="building-body" style="width: 65px; height: 130px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
   <div class="building">
    <div class="text-2xl">
     ‚≠ê
    </div>
    <div class="building-body" style="width: 50px; height: 95px;">
     <div class="building-windows">
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
      <div class="window-row">
       <div class="window"></div>
       <div class="window"></div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Forest Background -->
  <div class="forest">
   <div class="tree large">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree large">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree large">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree large">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
   <div class="tree small">
    <div class="tree-top"></div>
    <div class="tree-middle"></div>
    <div class="tree-bottom"></div>
    <div class="tree-trunk"></div>
   </div>
  </div><!-- Snowflakes Animation -->
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div>
  <div class="snowflake">
   ‚ùÜ
  </div>
  <div class="snowflake">
   ‚ùÑÔ∏è
  </div>
  <div class="snowflake">
   ‚ùÖ
  </div><!-- MODO ADMINISTRADOR -->
  <div id="admin-mode" class="min-h-full flex flex-col relative hidden" style="z-index: 10;"><!-- Login Section -->
   <div id="admin-login-section" class="min-h-full flex items-center justify-center px-6 py-12">
    <div class="max-w-md w-full"><!-- Header -->
     <div class="text-center mb-8">
      <div class="inline-block text-8xl mb-4">
       üîß
      </div>
      <h1 id="admin-title" class="text-4xl font-bold text-gray-900 mb-2">Portal Administrador</h1>
      <h2 id="admin-event-name" class="text-xl text-gray-600 mb-4">Intercambio Navide√±o 2025</h2><!-- Decorative elements -->
      <div class="flex justify-center items-center gap-2 mb-6"><span class="text-2xl animate-bounce">üéÅ</span> <span class="text-lg">„Éª</span> <span class="text-2xl animate-pulse">‚öôÔ∏è</span> <span class="text-lg">„Éª</span> <span class="text-2xl animate-bounce">üéÑ</span>
      </div>
     </div><!-- Login Card -->
     <div class="admin-card rounded-2xl p-8 text-white shadow-2xl">
      <div class="text-center mb-6">
       <div class="text-5xl mb-4">
        üîê
       </div>
       <h3 class="text-2xl font-bold mb-2">Acceso Administrador</h3>
       <p id="admin-welcome-message" class="text-sm opacity-90">Gestiona tu intercambio de regalos</p>
      </div>
      <form id="admin-login-form" class="space-y-4">
       <div><label for="admin-security-code" id="admin-security-code-label" class="block text-sm font-medium mb-2 opacity-90">C√≥digo de Seguridad</label> <input type="password" id="admin-security-code" name="security-code" required class="w-full px-4 py-3 rounded-lg bg-white bg-opacity-90 border border-white border-opacity-30 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 focus:bg-white" placeholder="Ingresa el c√≥digo">
       </div><button type="submit" id="admin-login-btn" class="w-full bg-white text-orange-600 font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 hover:shadow-lg"> <span class="flex items-center justify-center gap-2"> <span class="text-xl">üîì</span> <span>Acceder al Panel</span> </span> </button>
      </form><!-- Error Message -->
      <div id="admin-error-message" class="mt-4 p-3 bg-red-500 bg-opacity-20 border border-red-300 border-opacity-30 rounded-lg text-center text-sm hidden"><span class="mr-2">‚ùå</span> <span>C√≥digo de seguridad incorrecto.</span>
      </div>
     </div><!-- Security Code Info -->
     <div class="mt-8 bg-white rounded-lg p-6 shadow-md">
      <div class="text-center">
       <div class="text-3xl mb-3">
        üîë
       </div>
       <h4 class="font-bold text-gray-800 mb-2">C√≥digo de Seguridad</h4>
       <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-300">
        <p class="text-2xl font-mono font-bold text-orange-600">ADMIN2025</p>
       </div>
       <p class="text-xs text-gray-500 mt-3">Usa este c√≥digo para acceder al panel de administraci√≥n</p>
      </div>
     </div><!-- Mode Switcher -->
     <div class="mt-6 text-center"><a href="?mode=participant" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg"> <span class="flex items-center gap-2"> <span class="text-xl">üë§</span> <span>Ir al Portal de Participantes</span> </span> </a>
     </div>
    </div>
   </div><!-- Dashboard Section -->
   <div id="admin-dashboard-section" class="hidden min-h-full flex flex-col"><!-- Header -->
    <header class="bg-gradient-to-r from-orange-600 to-amber-600 text-white shadow-lg">
     <div class="max-w-6xl mx-auto px-6 py-6">
      <div class="flex items-center justify-between">
       <div class="flex items-center">
        <div class="text-4xl mr-4">
         üîß
        </div>
        <div>
         <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
         <p class="text-lg opacity-90">Gestiona participantes y sorteos</p>
        </div>
       </div>
       <div class="flex items-center gap-3"><a href="?mode=participant" class="bg-blue-500 hover:bg-blue-600 rounded-xl px-4 py-2 border-2 border-white shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2 text-sm text-white font-semibold"> <span class="text-lg">üë§</span> <span>Participante</span> </span> </a> <button id="admin-logout-btn" class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 rounded-xl px-4 py-2 border-2 border-white shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2 text-sm text-white font-semibold"> <span class="text-lg">üö™</span> <span>Salir</span> </span> </button>
       </div>
      </div>
     </div>
    </header><!-- Main Content -->
    <main class="flex-1 max-w-6xl mx-auto px-6 py-8 w-full"><!-- Draw Selector -->
     <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <div class="flex items-center justify-between">
       <div class="flex items-center gap-4">
        <div class="text-4xl">
         üìã
        </div>
        <div>
         <h3 class="text-xl font-bold text-gray-800">Sorteo Actual</h3><select id="draw-selector" class="mt-2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white text-gray-800"> <option value="">Seleccionar sorteo...</option> </select>
        </div>
       </div><button id="new-draw-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2"> <span class="text-xl">‚ûï</span> <span>Nuevo Sorteo</span> </span> </button>
      </div>
     </div><!-- Stats Cards -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm opacity-90 mb-1">Total Participantes</p>
         <p class="text-4xl font-bold" id="total-participants">0</p>
        </div>
        <div class="text-5xl opacity-80">
         üë•
        </div>
       </div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm opacity-90 mb-1">Asignaciones</p>
         <p class="text-4xl font-bold" id="total-assignments">0</p>
        </div>
        <div class="text-5xl opacity-80">
         üéÅ
        </div>
       </div>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm opacity-90 mb-1">Estado Sorteo</p>
         <p class="text-lg font-bold" id="draw-status">Sin Sortear</p>
        </div>
        <div class="text-5xl opacity-80 dice-roll" id="dice-icon">
         üé≤
        </div>
       </div>
      </div>
     </div><!-- Action Buttons -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><button id="add-participant-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center justify-center gap-3"> <span class="text-2xl">‚ûï</span> <span class="text-lg">Agregar Participante</span> </span> </button> <button id="restrictions-btn" class="bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center justify-center gap-3"> <span class="text-2xl">üö´</span> <span class="text-lg">Restricciones</span> </span> </button> <button id="draw-btn" class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center justify-center gap-3"> <span class="text-2xl">üé≤</span> <span class="text-lg">Realizar Sorteo</span> </span> </button>
     </div><!-- Participants List -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
       <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üìã</span> <span>Lista de Participantes</span></h3>
       <div class="flex gap-3"><button id="generate-invitation-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2"> <span class="text-xl">üìß</span> <span>Generar Invitaci√≥n</span> </span> </button> <button id="export-csv-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2"> <span class="text-xl">üì•</span> <span>Exportar CSV</span> </span> </button>
       </div>
      </div>
      <div id="participants-list" class="space-y-4"><!-- Participants will be rendered here -->
      </div>
      <div id="empty-state" class="text-center py-12">
       <div class="text-6xl mb-4">
        üë•
       </div>
       <h4 class="text-xl font-bold text-gray-700 mb-2">No hay participantes</h4>
       <p class="text-gray-500 mb-6">Comienza agregando el primer participante</p><button onclick="document.getElementById('add-participant-btn').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>‚ûï</span> <span>Agregar Participante</span> </span> </button>
      </div>
     </div><!-- Personal Invitation Display -->
     <div id="invitation-display" class="hidden bg-white rounded-xl shadow-lg p-6 mt-8">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üìß</span> <span>Invitaci√≥n para <span id="participant-name-display" class="text-orange-600"></span></span></h3><button onclick="closeInvitationDisplay()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
      </div>
      <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-6 border-2 border-orange-200">
       <div id="invitation-text" class="text-gray-800 whitespace-pre-wrap font-mono text-sm leading-relaxed"></div>
      </div><button onclick="copyInvitation()" class="mt-4 w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center justify-center gap-2"> <span class="text-xl">üìã</span> <span>Copiar Invitaci√≥n</span> </span> </button>
     </div>
    </main><!-- Footer -->
    <footer class="bg-gray-800 text-white py-6">
     <div class="max-w-6xl mx-auto px-6 text-center">
      <div class="flex justify-center items-center gap-2 mb-2"><span class="animate-bounce">üéÖ</span> <span class="animate-pulse">üéÑ</span> <span class="animate-bounce">‚≠ê</span> <span class="animate-pulse">üéÅ</span> <span class="animate-bounce">üéâ</span>
      </div>
      <p class="text-gray-300">Portal de Administraci√≥n - Intercambio de Regalos 2025</p>
      <p class="text-xs text-gray-400 mt-1">Sistema de gesti√≥n completo</p>
     </div>
    </footer>
   </div>
  </div><!-- MODO PARTICIPANTE -->
  <div id="participant-mode" class="min-h-full flex flex-col relative hidden" style="z-index: 10;"><!-- Login Section -->
   <div id="participant-login-section" class="min-h-full flex items-center justify-center px-6 py-12">
    <div class="max-w-md w-full"><!-- Header -->
     <div class="text-center mb-8">
      <div class="inline-block text-8xl mb-4">
       üéÅ
      </div>
      <h1 id="participant-title" class="text-4xl font-bold text-gray-900 mb-2">Mi Intercambio de Regalos</h1>
      <h2 id="participant-event-name" class="text-xl text-gray-600 mb-4">Intercambio Navide√±o 2025</h2><!-- Decorative elements -->
      <div class="flex justify-center items-center gap-2 mb-6"><span class="text-2xl animate-bounce">üéÑ</span> <span class="text-lg">„Éª</span> <span class="text-2xl animate-pulse">üéÅ</span> <span class="text-lg">„Éª</span> <span class="text-2xl animate-bounce">üéÖ</span>
      </div>
     </div><!-- Login Card -->
     <div class="participant-card rounded-2xl p-8 text-white shadow-2xl">
      <div class="text-center mb-6">
       <div class="text-5xl mb-4">
        üéÑ
       </div>
       <h3 class="text-2xl font-bold mb-2">Acceso Participante</h3>
       <p id="participant-welcome" class="text-sm opacity-90">Bienvenido al intercambio</p>
      </div>
      <form id="participant-login-form" class="space-y-4">
       <div><label for="participant-username" class="block text-sm font-medium mb-2 opacity-90">Usuario</label> <input type="text" id="participant-username" name="username" required class="w-full px-4 py-3 rounded-lg bg-white bg-opacity-90 border border-white border-opacity-30 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 focus:bg-white" placeholder="Tu usuario">
       </div>
       <div><label for="participant-password" class="block text-sm font-medium mb-2 opacity-90">Contrase√±a</label> <input type="password" id="participant-password" name="password" required class="w-full px-4 py-3 rounded-lg bg-white bg-opacity-90 border border-white border-opacity-30 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 focus:bg-white" placeholder="Tu contrase√±a">
       </div><button type="submit" id="participant-login-btn" class="w-full bg-white text-blue-600 font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 hover:shadow-lg"> <span class="flex items-center justify-center gap-2"> <span class="text-xl">üéÅ</span> <span>Ingresar</span> </span> </button>
      </form><!-- Error Message -->
      <div id="participant-error-message" class="mt-4 p-3 bg-red-500 bg-opacity-20 border border-red-300 border-opacity-30 rounded-lg text-center text-sm hidden"><span class="mr-2">‚ùå</span> <span>Usuario o contrase√±a incorrectos.</span>
      </div>
     </div><!-- Help Info -->
     <div class="mt-8 bg-white rounded-lg p-6 shadow-md">
      <div class="text-center">
       <div class="text-3xl mb-3">
        üí°
       </div>
       <h4 class="font-bold text-gray-800 mb-2">¬øNo tienes tus credenciales?</h4>
       <p class="text-sm text-gray-600">Solicita tu usuario y contrase√±a al administrador del intercambio</p>
      </div>
     </div><!-- Mode Switcher -->
     <div class="mt-6 text-center"><a href="?mode=admin" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg"> <span class="flex items-center gap-2"> <span class="text-xl">üîß</span> <span>Ir al Portal de Administrador</span> </span> </a>
     </div>
    </div>
   </div><!-- Dashboard Section -->
   <div id="participant-dashboard-section" class="hidden min-h-full flex flex-col"><!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg">
     <div class="max-w-4xl mx-auto px-6 py-6">
      <div class="flex items-center justify-between">
       <div class="flex items-center">
        <div class="text-4xl mr-4">
         üéÅ
        </div>
        <div>
         <h1 class="text-3xl font-bold">¬°Hola, <span id="logged-participant-name">Participante</span>!</h1>
         <p class="text-lg opacity-90">Tu intercambio de regalos</p>
        </div>
       </div><button id="participant-logout-btn" class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 rounded-xl px-4 py-2 border-2 border-white shadow-lg transition-all duration-200 transform hover:scale-105"> <span class="flex items-center gap-2 text-sm text-white font-semibold"> <span class="text-lg">üö™</span> <span>Salir</span> </span> </button>
      </div>
     </div>
    </header><!-- Main Content -->
    <main class="flex-1 max-w-4xl mx-auto px-6 py-8 w-full"><!-- Assignment Card -->
     <div id="assignment-card" class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
      <div class="text-center">
       <div class="text-7xl mb-6">
        üéÑ
       </div>
       <h2 class="text-3xl font-bold text-gray-800 mb-4">Tu Amigo Secreto</h2>
       <div id="assignment-content" class="hidden">
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-8 border-2 border-green-300 mb-6">
         <p class="text-lg text-gray-700 mb-4">Le regalar√°s a:</p>
         <p class="text-4xl font-bold text-green-700 mb-3" id="assigned-name">---</p>
         <p class="text-md text-gray-600" id="assigned-email">---</p>
        </div>
        <div class="bg-amber-50 rounded-lg p-6 border border-amber-200">
         <p class="text-sm text-amber-800"><span class="font-bold">ü§´ Recuerda:</span> Mant√©n este nombre en secreto. ¬°Es parte de la diversi√≥n del intercambio!</p>
        </div>
       </div>
       <div id="no-assignment-content" class="hidden">
        <div class="bg-gray-50 rounded-xl p-8 border-2 border-gray-200">
         <p class="text-xl text-gray-600 mb-4">‚è≥ A√∫n no se ha realizado el sorteo</p>
         <p class="text-sm text-gray-500">El administrador realizar√° el sorteo pronto. Vuelve m√°s tarde para ver a qui√©n le regalar√°s.</p>
        </div>
       </div>
      </div>
     </div><!-- Event Info Card -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="text-center">
       <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-2"><span class="text-3xl">üìÖ</span> <span id="event-info-title">Intercambio Navide√±o 2025</span></h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
         <div class="text-3xl mb-2">
          üéâ
         </div>
         <p class="text-sm font-semibold text-gray-700">Prepara tu regalo</p>
         <p class="text-xs text-gray-500 mt-1">Con cari√±o y creatividad</p>
        </div>
        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
         <div class="text-3xl mb-2">
          ü§ê
         </div>
         <p class="text-sm font-semibold text-gray-700">Mant√©n el secreto</p>
         <p class="text-xs text-gray-500 mt-1">No reveles a qui√©n le regalas</p>
        </div>
        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
         <div class="text-3xl mb-2">
          ÔøΩÔøΩ
         </div>
         <p class="text-sm font-semibold text-gray-700">Disfruta el d√≠a</p>
         <p class="text-xs text-gray-500 mt-1">¬°Ser√° una gran celebraci√≥n!</p>
        </div>
       </div>
      </div>
     </div>
    </main><!-- Footer -->
    <footer class="bg-gray-800 text-white py-6">
     <div class="max-w-4xl mx-auto px-6 text-center">
      <div class="flex justify-center items-center gap-2 mb-2"><span class="animate-bounce">üéÖ</span> <span class="animate-pulse">üéÑ</span> <span class="animate-bounce">‚≠ê</span> <span class="animate-pulse">üéÅ</span> <span class="animate-bounce">üéâ</span>
      </div>
      <p class="text-gray-300">Portal de Participantes - Intercambio de Regalos 2025</p>
      <p class="text-xs text-gray-400 mt-1">¬°Felices fiestas!</p>
     </div>
    </footer>
   </div>
  </div><!-- MODALS (Compartidos entre ambos modos) --> <!-- Add Participant Modal -->
  <div id="add-participant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4" style="z-index: 1000;">
   <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl fade-in">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üë§</span> <span>Nuevo Participante</span></h3><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <form id="participant-form" class="space-y-4">
     <div><label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label> <input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Juan P√©rez">
     </div>
     <div><label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email (Opcional)</label> <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="juan@email.com">
     </div>
     <div><label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label> <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+51 999 999 999">
     </div>
     <div class="bg-gray-50 rounded-lg p-4 border border-gray-200"><label class="flex items-center gap-2 cursor-pointer"> <input type="checkbox" id="enable-credentials" class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm font-medium text-gray-700">Agregar credenciales de acceso</span> </label>
     </div>
     <div id="credentials-section" class="hidden space-y-4">
      <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Usuario</label> <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="juan123">
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label> <input type="text" id="password-input" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pass123">
      </div>
     </div>
     <div class="flex gap-3 pt-4"><button type="button" id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors"> Cancelar </button> <button type="submit" id="save-participant-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>üíæ</span> <span>Guardar</span> </span> </button>
     </div>
    </form>
   </div>
  </div><!-- Restrictions Modal -->
  <div id="restrictions-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4" style="z-index: 1000;">
   <div class="bg-white rounded-2xl p-8 max-w-2xl w-full shadow-2xl fade-in max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üö´</span> <span>Restricciones de Sorteo</span></h3><button id="close-restrictions-btn" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <p class="text-sm text-gray-600 mb-4">Define parejas que NO deben regalarse entre s√≠ (ej: hermanos, esposos)</p>
    <div class="mb-6">
     <div class="grid grid-cols-2 gap-4 mb-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Persona 1</label> <select id="restriction-person1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"> <option value="">Seleccionar...</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Persona 2</label> <select id="restriction-person2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"> <option value="">Seleccionar...</option> </select>
      </div>
     </div><button id="add-restriction-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>‚ûï</span> <span>Agregar Restricci√≥n</span> </span> </button>
    </div>
    <div id="restrictions-list" class="space-y-2 mb-6"><!-- Restrictions will appear here -->
    </div><button id="close-restrictions-modal-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors"> Cerrar </button>
   </div>
  </div><!-- Select Participant Modal -->
  <div id="select-participant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4" style="z-index: 1000;">
   <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl fade-in">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üìß</span> <span>Seleccionar Participante</span></h3><button id="close-select-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <p class="text-sm text-gray-600 mb-4">Selecciona el participante para generar su invitaci√≥n personal:</p>
    <div class="mb-6"><label for="participant-select" class="block text-sm font-medium text-gray-700 mb-2">Participante</label> <select id="participant-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Seleccionar...</option> </select>
    </div>
    <div class="flex gap-3"><button id="cancel-select-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors"> Cancelar </button> <button id="confirm-select-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>‚úÖ</span> <span>Generar</span> </span> </button>
    </div>
   </div>
  </div><!-- Edit Participant Modal -->
  <div id="edit-participant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4" style="z-index: 1000;">
   <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl fade-in">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">‚úèÔ∏è</span> <span>Editar Participante</span></h3><button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <form id="edit-participant-form" class="space-y-4"><input type="hidden" id="edit-participant-id" name="edit-participant-id">
     <div><label for="edit-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label> <input type="text" id="edit-name" name="edit-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Juan P√©rez">
     </div>
     <div><label for="edit-email" class="block text-sm font-medium text-gray-700 mb-2">Email (Opcional)</label> <input type="email" id="edit-email" name="edit-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="juan@email.com">
     </div>
     <div><label for="edit-phone" class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label> <input type="tel" id="edit-phone" name="edit-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+51 999 999 999">
     </div>
     <div><label for="edit-username" class="block text-sm font-medium text-gray-700 mb-2">Usuario (Opcional)</label> <input type="text" id="edit-username" name="edit-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="juan123">
     </div>
     <div><label for="edit-password" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a (Opcional)</label> <input type="text" id="edit-password-input" name="edit-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pass123">
     </div>
     <div class="flex gap-3 pt-4"><button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors"> Cancelar </button> <button type="submit" id="update-participant-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>üíæ</span> <span>Actualizar</span> </span> </button>
     </div>
    </form>
   </div>
  </div><!-- New Draw Modal -->
  <div id="new-draw-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4" style="z-index: 1000;">
   <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl fade-in">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">üé≤</span> <span>Nuevo Sorteo</span></h3><button id="close-new-draw-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
    </div>
    <form id="new-draw-form" class="space-y-4">
     <div><label for="draw-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del Sorteo *</label> <input type="text" id="draw-name" name="draw-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ej: Intercambio Familia 2025">
     </div>
     <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
      <p class="text-sm text-blue-800"><span class="font-bold">‚ÑπÔ∏è Nota:</span> Se crear√° un nuevo sorteo vac√≠o. Podr√°s agregar participantes despu√©s de crearlo.</p>
     </div>
     <div class="flex gap-3 pt-4"><button type="button" id="cancel-new-draw-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors"> Cancelar </button> <button type="submit" id="create-draw-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors"> <span class="flex items-center justify-center gap-2"> <span>‚úÖ</span> <span>Crear</span> </span> </button>
     </div>
    </form>
   </div>
  </div>
  <script>
        // DETECT MODE FROM URL
        function getModeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode')) {
                return urlParams.get('mode');
            }
            
            const hash = window.location.hash;
            if (hash.includes('mode=')) {
                const hashParams = new URLSearchParams(hash.substring(1));
                return hashParams.get('mode');
            }
            
            if (hash === '#participant') return 'participant';
            if (hash === '#admin') return 'admin';
            
            return 'admin';
        }
        
        const mode = getModeFromURL();
        console.log('Detected mode:', mode);
        
        // Global variables
        let restrictions = [];
        let currentInvitationText = '';
        const ADMIN_CODE = "ADMIN2025";
        let allRecords = [];
        let participants = [];
        let draws = [];
        let currentDrawId = null;
        let isLoggedIn = false;
        let currentUser = null;
        let isDrawing = false;
        let editingParticipant = null;

        // Configuration
        const defaultConfig = {
            admin_title: "Portal Administrador",
            participant_title: "Mi Intercambio de Regalos",
            event_name: "Intercambio Navide√±o 2025",
            welcome_message: "Gestiona tu intercambio de regalos",
            participant_welcome: "Bienvenido al intercambio",
            security_code_label: "C√≥digo de Seguridad",
            background_color: "#fffbeb",
            primary_color: "#fb923c",
            secondary_color: "#f97316",
            text_color: "#374151",
            surface_color: "#ffffff"
        };

        // Sleigh animation functions
        function showSleighAnimation() {
            document.getElementById('sleigh-overlay').classList.remove('hidden');
        }

        function hideSleighAnimation() {
            document.getElementById('sleigh-overlay').classList.add('hidden');
        }

        function updateSleighMessage(message) {
            document.getElementById('sleigh-message-text').textContent = message;
        }

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                allRecords = data || [];
                draws = allRecords.filter(r => r.recordType === 'draw');
                
                // Update draw selector
                if (mode === 'admin' && isLoggedIn) {
                    updateDrawSelector();
                    
                    if (currentDrawId) {
                        participants = allRecords.filter(r => r.recordType === 'participant' && r.drawId === currentDrawId);
                        restrictions = allRecords.filter(r => r.recordType === 'restriction' && r.drawId === currentDrawId);
                        
                        updateDashboard();
                        renderParticipantsList();
                        updateRestrictionsSelects();
                        renderRestrictionsList();
                    }
                } else if (mode === 'participant' && isLoggedIn && currentUser) {
                    // Find current user in updated data
                    const updatedUser = allRecords.find(r => 
                        r.recordType === 'participant' && 
                        r.username === currentUser.username
                    );
                    
                    if (updatedUser) {
                        currentUser = updatedUser;
                        updateParticipantDashboard();
                    }
                }
            }
        };

        // Initialize mode on page load
        function initializeMode() {
            const adminMode = document.getElementById('admin-mode');
            const participantMode = document.getElementById('participant-mode');
            
            console.log('Initializing mode:', mode);
            
            if (mode === 'participant') {
                console.log('Showing participant mode');
                adminMode.classList.add('hidden');
                participantMode.classList.remove('hidden');
            } else {
                console.log('Showing admin mode');
                participantMode.classList.add('hidden');
                adminMode.classList.remove('hidden');
            }
        }

        // Update draw selector
        function updateDrawSelector() {
            const selector = document.getElementById('draw-selector');
            if (!selector) return;
            
            const currentValue = selector.value;
            selector.innerHTML = '<option value="">Seleccionar sorteo...</option>';
            
            draws.forEach(draw => {
                const option = document.createElement('option');
                option.value = draw.id;
                option.textContent = draw.drawName + ' (' + new Date(draw.drawDate).toLocaleDateString() + ')';
                selector.appendChild(option);
            });
            
            if (currentValue && draws.some(d => d.id === currentValue)) {
                selector.value = currentValue;
            } else if (draws.length > 0 && !currentDrawId) {
                selector.value = draws[0].id;
                currentDrawId = draws[0].id;
                updateCurrentDraw();
            }
        }

        // Handle draw selector change
        document.getElementById('draw-selector')?.addEventListener('change', (e) => {
            currentDrawId = e.target.value;
            updateCurrentDraw();
        });

        // Update current draw data
        function updateCurrentDraw() {
            if (currentDrawId) {
                participants = allRecords.filter(r => r.recordType === 'participant' && r.drawId === currentDrawId);
                restrictions = allRecords.filter(r => r.recordType === 'restriction' && r.drawId === currentDrawId);
                
                updateDashboard();
                renderParticipantsList();
                updateRestrictionsSelects();
                renderRestrictionsList();
            } else {
                participants = [];
                restrictions = [];
                updateDashboard();
                renderParticipantsList();
            }
        }

        // New draw button handler
        document.getElementById('new-draw-btn')?.addEventListener('click', () => {
            openNewDrawModal();
        });

        // New draw form handler
        document.getElementById('new-draw-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const drawName = formData.get('draw-name').trim();
            
            if (allRecords.length >= 999) {
                showToast("L√≠mite de 999 registros alcanzado.", "error");
                return;
            }
            
            const createBtn = document.getElementById('create-draw-btn');
            const originalContent = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="spinner"></div><span>Creando...</span></div>';
            
            const drawId = generateId();
            const drawData = {
                id: drawId,
                recordType: 'draw',
                drawName: drawName,
                drawDate: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                name: drawName,
                email: '',
                phone: '',
                username: '',
                password: '',
                assignedTo: '',
                assignedToEmail: '',
                drawId: drawId,
                person1Id: '',
                person2Id: ''
            };
            
            const result = await window.dataSdk.create(drawData);
            
            createBtn.disabled = false;
            createBtn.innerHTML = originalContent;
            
            if (result.isOk) {
                closeNewDrawModal();
                currentDrawId = drawId;
                
                // Wait for data to update
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const selector = document.getElementById('draw-selector');
                if (selector) {
                    selector.value = drawId;
                }
                
                updateCurrentDraw();
                showToast("Sorteo creado exitosamente.", "success");
            } else {
                showToast("Error al crear sorteo.", "error");
            }
        });

        // Modal handlers for new draw
        document.getElementById('close-new-draw-modal-btn')?.addEventListener('click', () => {
            closeNewDrawModal();
        });

        document.getElementById('cancel-new-draw-btn')?.addEventListener('click', () => {
            closeNewDrawModal();
        });

        document.getElementById('new-draw-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'new-draw-modal') {
                closeNewDrawModal();
            }
        });

        function openNewDrawModal() {
            document.getElementById('new-draw-modal').classList.remove('hidden');
        }

        function closeNewDrawModal() {
            document.getElementById('new-draw-modal').classList.add('hidden');
            document.getElementById('new-draw-form').reset();
        }

        // ========================================
        // ADMIN MODE FUNCTIONS
        // ========================================

        // Admin login handler
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const code = formData.get('security-code').trim();
            
            if (code === ADMIN_CODE) {
                isLoggedIn = true;
                showAdminDashboard();
                showToast("¬°Bienvenido Administrador!", "success");
            } else {
                showAdminLoginError();
                showToast("C√≥digo de seguridad incorrecto.", "error");
            }
        });

        // Admin logout handler
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            isLoggedIn = false;
            showAdminLogin();
            showToast("Has cerrado sesi√≥n.", "info");
        });

        // Show admin login
        function showAdminLogin() {
            document.getElementById('admin-login-section').classList.remove('hidden');
            document.getElementById('admin-dashboard-section').classList.add('hidden');
            
            document.getElementById('admin-login-form').reset();
            document.getElementById('admin-error-message').classList.add('hidden');
        }

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('admin-login-section').classList.add('hidden');
            document.getElementById('admin-dashboard-section').classList.remove('hidden');
            
            updateDrawSelector();
            updateDashboard();
            renderParticipantsList();
        }

        // Show admin login error
        function showAdminLoginError() {
            const errorDiv = document.getElementById('admin-error-message');
            const loginForm = document.getElementById('admin-login-form');
            
            errorDiv.classList.remove('hidden');
            loginForm.classList.add('shake-animation');
            
            setTimeout(() => {
                loginForm.classList.remove('shake-animation');
            }, 500);
        }

        // Update admin dashboard stats
        function updateDashboard() {
            document.getElementById('total-participants').textContent = participants.length;
            
            const assignedCount = participants.filter(p => p.assignedTo).length;
            document.getElementById('total-assignments').textContent = assignedCount;
            
            const statusElement = document.getElementById('draw-status');
            const diceIcon = document.getElementById('dice-icon');
            if (assignedCount > 0) {
                statusElement.textContent = 'Sorteado ‚úì';
                statusElement.parentElement.parentElement.classList.remove('from-purple-500', 'to-purple-600');
                statusElement.parentElement.parentElement.classList.add('from-green-500', 'to-green-600');
                if (diceIcon) diceIcon.classList.remove('dice-roll');
            } else {
                statusElement.textContent = 'Sin Sortear';
                statusElement.parentElement.parentElement.classList.remove('from-green-500', 'to-green-600');
                statusElement.parentElement.parentElement.classList.add('from-purple-500', 'to-purple-600');
                if (diceIcon) diceIcon.classList.add('dice-roll');
            }
        }

        // Toggle assignment visibility
        function toggleAssignment(backendId) {
            const textElements = document.querySelectorAll(`.assignment-text.${backendId}`);
            const hiddenElement = document.querySelector(`.assignment-hidden.${backendId}`);
            const eyeButton = document.querySelector(`.toggle-eye-${backendId}`);
            
            const isHidden = textElements[0].style.display === 'none';
            
            textElements.forEach(el => {
                el.style.display = isHidden ? 'block' : 'none';
            });
            
            if (hiddenElement) {
                hiddenElement.style.display = isHidden ? 'none' : 'block';
            }
            
            if (eyeButton) {
                eyeButton.textContent = isHidden ? 'üôà' : 'üëÅÔ∏è';
            }
        }

        // Generate personal invite
        function generatePersonalInvite(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            const currentUrl = window.location.href.split('?')[0];
            const participantUrl = `${currentUrl}?mode=participant`;
            
            const inviteText = `üéÑ ¬°Hola ${participant.name}! üéÅ

¬°Es hora del intercambio de regalos navide√±o!

üîë Tus credenciales de acceso al portal:
üë§ Usuario: ${participant.username}
üîê Contrase√±a: ${participant.password}

üåê Accede al portal aqu√≠:
${participantUrl}

‚ú® ¬°Ingresa al portal y descubre a qui√©n le toca regalarle!

¬°Prepara un regalo especial! üéä

üìã Para tu facilidad, aqu√≠ est√°n tus credenciales para copiar f√°cilmente:

${participant.username}

${participant.password}

¬°Felices Fiestas! üéâ`;
            
            currentInvitationText = inviteText;
            document.getElementById('participant-name-display').textContent = participant.name;
            document.getElementById('invitation-text').textContent = inviteText;
            document.getElementById('invitation-display').classList.remove('hidden');
            
            document.getElementById('invitation-display').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Close invitation display
        function closeInvitationDisplay() {
            document.getElementById('invitation-display').classList.add('hidden');
        }

        // Copy invitation to clipboard
        function copyInvitation() {
            const textArea = document.createElement('textarea');
            textArea.value = currentInvitationText;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast("¬°Invitaci√≥n copiada al portapapeles!", "success");
            } catch (err) {
                showToast("Error al copiar. Intenta seleccionar manualmente.", "error");
            }
            
            document.body.removeChild(textArea);
        }

        // Render participants list
        function renderParticipantsList() {
            const listContainer = document.getElementById('participants-list');
            const emptyState = document.getElementById('empty-state');
            
            if (participants.length === 0) {
                listContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            listContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            listContainer.innerHTML = participants.map(participant => `
                <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="text-3xl mr-4">üë§</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 text-lg">${participant.name}</h4>
                                <p class="text-sm text-gray-600">${participant.email}</p>
                                <p class="text-sm text-gray-600">üì± ${participant.phone}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Usuario: ${participant.username}</span>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Pass: ${participant.password}</span>
                                </div>
                                ${participant.assignedTo ? `
                                    <div class="mt-2 bg-green-50 border border-green-200 rounded-lg p-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <p class="text-xs text-green-700 font-semibold assignment-text ${participant.__backendId}" style="display:none;">üéÅ Asignado a: ${participant.assignedTo}</p>
                                                <p class="text-xs text-green-600 assignment-text ${participant.__backendId}" style="display:none;">${participant.assignedToEmail || ''}</p>
                                                <p class="text-xs text-green-700 font-semibold assignment-hidden ${participant.__backendId}">üéÅ Asignaci√≥n oculta</p>
                                            </div>
                                            <button onclick="toggleAssignment('${participant.__backendId}')" class="ml-2 text-xl hover:scale-110 transition-transform toggle-eye-${participant.__backendId}">
                                                üëÅÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <button onclick="editParticipant('${participant.__backendId}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-lg transition-colors">
                                <span class="text-xl">‚úèÔ∏è</span>
                            </button>
                            <button onclick="deleteParticipant('${participant.__backendId}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold p-3 rounded-lg transition-colors">
                                <span class="text-xl">üóëÔ∏è</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Edit participant
        function editParticipant(backendId) {
            const participant = participants.find(p => p.__backendId === backendId);
            if (!participant) return;
            
            editingParticipant = participant;
            
            document.getElementById('edit-participant-id').value = participant.__backendId;
            document.getElementById('edit-name').value = participant.name;
            document.getElementById('edit-email').value = participant.email;
            document.getElementById('edit-phone').value = participant.phone;
            document.getElementById('edit-username').value = participant.username;
            document.getElementById('edit-password-input').value = participant.password;
            
            openEditParticipantModal();
        }

        // Delete participant
        async function deleteParticipant(backendId) {
            const participant = participants.find(p => p.__backendId === backendId);
            if (!participant) return;
            
            showConfirmModal(
                "¬øEliminar participante?",
                `¬øEst√°s seguro de eliminar a ${participant.name}? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    const result = await window.dataSdk.delete(participant);
                    
                    if (result.isOk) {
                        showToast("Participante eliminado exitosamente.", "success");
                    } else {
                        showToast("Error al eliminar el participante. Intenta nuevamente.", "error");
                    }
                }
            );
        }

        // Perform draw with improved algorithm and synchronization
        async function performDraw() {
            if (!currentDrawId) {
                showToast("Por favor selecciona un sorteo primero.", "error");
                return;
            }
            
            if (isDrawing) {
                showToast("Ya hay un sorteo en progreso. Por favor espera.", "info");
                return;
            }
            
            isDrawing = true;
            
            const drawBtn = document.getElementById('draw-btn');
            const originalDrawBtnContent = drawBtn.innerHTML;
            drawBtn.disabled = true;
            drawBtn.innerHTML = '<span class="flex items-center justify-center gap-3"><div class="spinner"></div><span class="text-lg">Sorteando...</span></span>';
            
            showToast("Realizando sorteo... üé≤", "info");
            showSleighAnimation();
            
            try {
                // PHASE 0: Get fresh data from database
                updateSleighMessage("Preparando participantes...");
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const currentParticipants = allRecords.filter(r => r.recordType === 'participant' && r.drawId === currentDrawId);
                
                if (currentParticipants.length < 2) {
                    throw new Error("Necesitas al menos 2 participantes para realizar el sorteo.");
                }
                
                // PHASE 1: Ensure ALL participants have credentials
                updateSleighMessage("Generando credenciales de acceso...");
                
                const credentialUpdates = [];
                const allUsernames = new Set();
                
                // First pass: collect existing usernames
                currentParticipants.forEach(p => {
                    if (p.username) {
                        allUsernames.add(p.username);
                    }
                });
                
                // Second pass: generate credentials for those who don't have them
                for (const participant of currentParticipants) {
                    if (!participant.username || !participant.password) {
                        const username = generateUsername(participant.name);
                        const password = generatePassword();
                        
                        let finalUsername = username;
                        let usernameAttempt = 0;
                        while (allUsernames.has(finalUsername)) {
                            usernameAttempt++;
                            finalUsername = username + usernameAttempt;
                        }
                        
                        allUsernames.add(finalUsername);
                        
                        credentialUpdates.push({
                            participant: participant,
                            username: finalUsername,
                            password: password
                        });
                    }
                }
                
                // Update credentials if needed
                if (credentialUpdates.length > 0) {
                    for (let i = 0; i < credentialUpdates.length; i++) {
                        const updateInfo = credentialUpdates[i];
                        updateSleighMessage(`Generando credenciales (${i + 1}/${credentialUpdates.length})...`);
                        
                        const update = {
                            ...updateInfo.participant,
                            username: updateInfo.username,
                            password: updateInfo.password
                        };
                        
                        const result = await window.dataSdk.update(update);
                        if (!result.isOk) {
                            throw new Error("Error al generar credenciales");
                        }
                        
                        // Wait between each credential update
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                    
                    updateSleighMessage("Verificando credenciales...");
                    
                    // Extended wait for complete data propagation
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Verify all credentials were saved
                    const refreshedParticipants = allRecords.filter(r => r.recordType === 'participant' && r.drawId === currentDrawId);
                    const missingCredentials = refreshedParticipants.filter(p => !p.username || !p.password);
                    if (missingCredentials.length > 0) {
                        throw new Error(`Faltan credenciales para ${missingCredentials.length} participante(s). Por favor intenta nuevamente.`);
                    }
                }
                
                updateSleighMessage("Realizando sorteo m√°gico...");
                
                // PHASE 2: Perform the draw
                const verifiedParticipants = allRecords.filter(r => r.recordType === 'participant' && r.drawId === currentDrawId);
                
                let attempts = 0;
                const maxAttempts = 10000;
                let validAssignment = false;
                let assignments = [];
                
                while (!validAssignment && attempts < maxAttempts) {
                    attempts++;
                    assignments = [];
                    
                    const availableReceivers = new Map();
                    verifiedParticipants.forEach(giver => {
                        const possible = verifiedParticipants.filter(receiver => 
                            receiver.id !== giver.id && 
                            !violatesRestrictions(giver.id, receiver.id)
                        );
                        availableReceivers.set(giver.id, [...possible]);
                    });
                    
                    const shuffledGivers = [...verifiedParticipants];
                    for (let i = shuffledGivers.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledGivers[i], shuffledGivers[j]] = [shuffledGivers[j], shuffledGivers[i]];
                    }
                    
                    const usedReceivers = new Set();
                    validAssignment = true;
                    
                    for (const giver of shuffledGivers) {
                        const possible = availableReceivers.get(giver.id).filter(r => !usedReceivers.has(r.id));
                        
                        if (possible.length === 0) {
                            validAssignment = false;
                            break;
                        }
                        
                        const receiver = possible[Math.floor(Math.random() * possible.length)];
                        usedReceivers.add(receiver.id);
                        
                        assignments.push({
                            giver: giver,
                            receiver: receiver
                        });
                    }
                    
                    if (validAssignment && assignments.length !== verifiedParticipants.length) {
                        validAssignment = false;
                    }
                }
                
                if (!validAssignment) {
                    throw new Error("No se pudo realizar el sorteo respetando las restricciones. Intenta modificar las restricciones.");
                }
                
                updateSleighMessage("Asignando regalos...");
                
                // PHASE 3: Update all participants with assignments
                const assignmentUpdates = [];
                
                for (const assignment of assignments) {
                    const update = {
                        ...assignment.giver,
                        assignedTo: assignment.receiver.name,
                        assignedToEmail: assignment.receiver.email
                    };
                    
                    assignmentUpdates.push(update);
                }
                
                for (let i = 0; i < assignmentUpdates.length; i++) {
                    const update = assignmentUpdates[i];
                    const result = await window.dataSdk.update(update);
                    
                    if (!result.isOk) {
                        throw new Error(`Error al asignar participante ${i + 1} de ${assignmentUpdates.length}`);
                    }
                    
                    // Wait between each assignment update
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                updateSleighMessage("Finalizando sorteo...");
                
                // Final wait for complete data propagation
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                hideSleighAnimation();
                showToast("¬°Sorteo realizado exitosamente! üéâ", "success");
                
            } catch (error) {
                hideSleighAnimation();
                showToast(error.message || "Error al realizar el sorteo. Intenta nuevamente.", "error");
            } finally {
                isDrawing = false;
                drawBtn.disabled = false;
                drawBtn.innerHTML = originalDrawBtnContent;
            }
        }

        // Check if assignment violates restrictions
        function violatesRestrictions(giverId, receiverId) {
            return restrictions.some(r => 
                (r.person1Id === giverId && r.person2Id === receiverId) ||
                (r.person2Id === giverId && r.person1Id === receiverId)
            );
        }

        // Generate random credentials
        function generateUsername(name) {
            const cleanName = name.toLowerCase().replace(/\s+/g, '');
            const randomNum = Math.floor(Math.random() * 9000) + 1000;
            return cleanName.substring(0, 6) + randomNum;
        }

        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Update restrictions selects
        function updateRestrictionsSelects() {
            const select1 = document.getElementById('restriction-person1');
            const select2 = document.getElementById('restriction-person2');
            
            if (!select1 || !select2) return;
            
            const currentValue1 = select1.value;
            const currentValue2 = select2.value;
            
            select1.innerHTML = '<option value="">Seleccionar...</option>';
            select2.innerHTML = '<option value="">Seleccionar...</option>';
            
            participants.forEach(p => {
                const option1 = document.createElement('option');
                option1.value = p.id;
                option1.textContent = p.name;
                select1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = p.id;
                option2.textContent = p.name;
                select2.appendChild(option2);
            });
            
            select1.value = currentValue1;
            select2.value = currentValue2;
        }

        // Render restrictions list
        function renderRestrictionsList() {
            const listContainer = document.getElementById('restrictions-list');
            if (!listContainer) return;
            
            if (restrictions.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay restricciones definidas</p>';
                return;
            }
            
            listContainer.innerHTML = restrictions.map(restriction => {
                const person1 = participants.find(p => p.id === restriction.person1Id);
                const person2 = participants.find(p => p.id === restriction.person2Id);
                
                if (!person1 || !person2) return '';
                
                return `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-red-600">üö´</span>
                            <span class="text-sm font-medium text-gray-800">${person1.name} ‚Üî ${person2.name}</span>
                        </div>
                        <button onclick="deleteRestriction('${restriction.__backendId}')" 
                                class="text-red-500 hover:text-red-700 font-bold">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Delete restriction
        async function deleteRestriction(backendId) {
            const restriction = restrictions.find(r => r.__backendId === backendId);
            if (!restriction) return;
            
            const result = await window.dataSdk.delete(restriction);
            
            if (result.isOk) {
                showToast("Restricci√≥n eliminada exitosamente.", "success");
            } else {
                showToast("Error al eliminar restricci√≥n.", "error");
            }
        }

        // Export to CSV with proper functionality
        function exportToCSV() {
            if (participants.length === 0) {
                showToast("No hay participantes para exportar.", "error");
                return;
            }
            
            try {
                // Create CSV header
                const headers = ['Nombre', 'Email', 'Tel√©fono', 'Usuario', 'Contrase√±a', 'Asignado a', 'Email Asignado'];
                
                // Create CSV rows
                const rows = participants.map(p => [
                    p.name,
                    p.email || '',
                    p.phone,
                    p.username,
                    p.password,
                    p.assignedTo || 'Sin asignar',
                    p.assignedToEmail || ''
                ]);
                
                // Build CSV content with UTF-8 BOM
                let csvContent = '\uFEFF';
                csvContent += headers.join(',') + '\n';
                rows.forEach(row => {
                    const escapedRow = row.map(field => {
                        // Escape quotes and wrap in quotes
                        const escaped = String(field).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvContent += escapedRow.join(',') + '\n';
                });
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const currentDraw = draws.find(d => d.id === currentDrawId);
                const drawName = currentDraw ? currentDraw.drawName.replace(/[^a-z0-9]/gi, '_') : 'sorteo';
                const fileName = `${drawName}_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showToast("CSV exportado exitosamente: " + fileName, "success");
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showToast("Error al exportar CSV. Intenta nuevamente.", "error");
            }
        }

        // Check if there are any assignments
        function hasAssignments() {
            return participants.some(p => p.assignedTo);
        }

        // ========================================
        // PARTICIPANT MODE FUNCTIONS
        // ========================================

        // Participant login handler
        document.getElementById('participant-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginBtn = document.getElementById('participant-login-btn');
            const originalContent = loginBtn.innerHTML;
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="spinner"></div><span>Verificando...</span></div>';
            
            const formData = new FormData(e.target);
            const username = formData.get('username').trim();
            const password = formData.get('password').trim();
            
            // Wait for data to be loaded with timeout protection
            let attempts = 0;
            const maxAttempts = 20; // 10 seconds total (20 * 500ms)
            let allParticipants = [];
            
            while (attempts < maxAttempts) {
                allParticipants = allRecords.filter(r => r.recordType === 'participant');
                
                if (allParticipants.length > 0) {
                    break;
                }
                
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            if (allParticipants.length === 0) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalContent;
                showParticipantLoginError();
                showToast("No se pudieron cargar los datos. Intenta recargar la p√°gina.", "error");
                return;
            }
            
            // Search for user with case-insensitive username and exact password match
            const user = allParticipants.find(p => {
                const hasCredentials = p.username && p.password;
                if (!hasCredentials) return false;
                
                const usernameMatch = p.username.toLowerCase().trim() === username.toLowerCase().trim();
                const passwordMatch = p.password.trim() === password.trim();
                
                return usernameMatch && passwordMatch;
            });
            
            loginBtn.disabled = false;
            loginBtn.innerHTML = originalContent;
            
            if (user) {
                isLoggedIn = true;
                currentUser = user;
                showParticipantDashboard();
                showToast(`¬°Bienvenido ${user.name}!`, "success");
            } else {
                showParticipantLoginError();
                showToast("Usuario o contrase√±a incorrectos. Verifica los datos e intenta nuevamente.", "error");
            }
        });

        // Participant logout handler
        document.getElementById('participant-logout-btn').addEventListener('click', () => {
            isLoggedIn = false;
            currentUser = null;
            showParticipantLogin();
            showToast("Has cerrado sesi√≥n.", "info");
        });

        // Show participant login
        function showParticipantLogin() {
            document.getElementById('participant-login-section').classList.remove('hidden');
            document.getElementById('participant-dashboard-section').classList.add('hidden');
            
            document.getElementById('participant-login-form').reset();
            document.getElementById('participant-error-message').classList.add('hidden');
        }

        // Show participant dashboard
        function showParticipantDashboard() {
            document.getElementById('participant-login-section').classList.add('hidden');
            document.getElementById('participant-dashboard-section').classList.remove('hidden');
            
            updateParticipantDashboard();
        }

        // Show participant login error
        function showParticipantLoginError() {
            const errorDiv = document.getElementById('participant-error-message');
            const loginForm = document.getElementById('participant-login-form');
            
            errorDiv.classList.remove('hidden');
            loginForm.classList.add('shake-animation');
            
            setTimeout(() => {
                loginForm.classList.remove('shake-animation');
            }, 500);
        }

        // Update participant dashboard
        function updateParticipantDashboard() {
            if (!currentUser) return;
            
            // Update participant data with latest from database
            const allParticipants = allRecords.filter(r => r.recordType === 'participant');
            const latestUserData = allParticipants.find(p => p.id === currentUser.id);
            if (latestUserData) {
                currentUser = latestUserData;
            }
            
            document.getElementById('logged-participant-name').textContent = currentUser.name;
            document.getElementById('event-info-title').textContent = defaultConfig.event_name;
            
            if (currentUser.assignedTo) {
                document.getElementById('assignment-content').classList.remove('hidden');
                document.getElementById('no-assignment-content').classList.add('hidden');
                document.getElementById('assigned-name').textContent = currentUser.assignedTo;
                document.getElementById('assigned-email').textContent = currentUser.assignedToEmail || '';
            } else {
                document.getElementById('assignment-content').classList.add('hidden');
                document.getElementById('no-assignment-content').classList.remove('hidden');
            }
        }

        // ========================================
        // MODAL HANDLERS (ADMIN MODE)
        // ========================================

        // Add participant button
        document.getElementById('add-participant-btn').addEventListener('click', () => {
            if (!currentDrawId) {
                showToast("Por favor selecciona un sorteo primero.", "error");
                return;
            }
            openAddParticipantModal();
        });

        // Restrictions button
        document.getElementById('restrictions-btn').addEventListener('click', () => {
            if (!currentDrawId) {
                showToast("Por favor selecciona un sorteo primero.", "error");
                return;
            }
            openRestrictionsModal();
        });

        // Draw button
        document.getElementById('draw-btn').addEventListener('click', async () => {
            if (!currentDrawId) {
                showToast("Por favor selecciona un sorteo primero.", "error");
                return;
            }
            
            if (participants.length < 2) {
                showToast("Necesitas al menos 2 participantes para realizar el sorteo.", "error");
                return;
            }
            
            if (hasAssignments()) {
                showConfirmModal(
                    "¬øRealizar nuevo sorteo?",
                    "Ya existe un sorteo realizado. ¬øDeseas crear uno nuevo? Esto eliminar√° las asignaciones actuales.",
                    async () => {
                        await performDraw();
                    }
                );
            } else {
                await performDraw();
            }
        });

        // Export CSV button
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            exportToCSV();
        });

        // Generate invitation button
        document.getElementById('generate-invitation-btn').addEventListener('click', () => {
            if (participants.length === 0) {
                showToast("No hay participantes disponibles.", "error");
                return;
            }
            openSelectParticipantModal();
        });

        // Add Participant Modal handlers
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            closeAddParticipantModal();
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            closeAddParticipantModal();
        });

        document.getElementById('add-participant-modal').addEventListener('click', (e) => {
            if (e.target.id === 'add-participant-modal') {
                closeAddParticipantModal();
            }
        });

        // Restrictions Modal handlers
        document.getElementById('close-restrictions-btn').addEventListener('click', () => {
            closeRestrictionsModal();
        });

        document.getElementById('close-restrictions-modal-btn').addEventListener('click', () => {
            closeRestrictionsModal();
        });

        document.getElementById('restrictions-modal').addEventListener('click', (e) => {
            if (e.target.id === 'restrictions-modal') {
                closeRestrictionsModal();
            }
        });

        document.getElementById('add-restriction-btn').addEventListener('click', async () => {
            const person1Id = document.getElementById('restriction-person1').value;
            const person2Id = document.getElementById('restriction-person2').value;
            
            if (!person1Id || !person2Id) {
                showToast("Por favor selecciona ambas personas.", "error");
                return;
            }
            
            if (person1Id === person2Id) {
                showToast("No puedes seleccionar la misma persona dos veces.", "error");
                return;
            }
            
            const exists = restrictions.some(r => 
                (r.person1Id === person1Id && r.person2Id === person2Id) ||
                (r.person1Id === person2Id && r.person2Id === person1Id)
            );
            
            if (exists) {
                showToast("Esta restricci√≥n ya existe.", "error");
                return;
            }
            
            if (allRecords.length >= 999) {
                showToast("L√≠mite de 999 registros alcanzado.", "error");
                return;
            }
            
            const person1 = participants.find(p => p.id === person1Id);
            const person2 = participants.find(p => p.id === person2Id);
            
            const restrictionData = {
                id: generateId(),
                recordType: 'restriction',
                person1Id: person1Id,
                person2Id: person2Id,
                name: `${person1.name} - ${person2.name}`,
                createdAt: new Date().toISOString(),
                email: '',
                phone: '',
                username: '',
                password: '',
                assignedTo: '',
                assignedToEmail: '',
                drawId: currentDrawId,
                drawName: '',
                drawDate: ''
            };
            
            const result = await window.dataSdk.create(restrictionData);
            
            if (result.isOk) {
                showToast("Restricci√≥n agregada exitosamente.", "success");
                document.getElementById('restriction-person1').value = '';
                document.getElementById('restriction-person2').value = '';
            } else {
                showToast("Error al agregar restricci√≥n.", "error");
            }
        });

        // Select Participant Modal handlers
        document.getElementById('close-select-modal-btn').addEventListener('click', () => {
            closeSelectParticipantModal();
        });

        document.getElementById('cancel-select-btn').addEventListener('click', () => {
            closeSelectParticipantModal();
        });

        document.getElementById('select-participant-modal').addEventListener('click', (e) => {
            if (e.target.id === 'select-participant-modal') {
                closeSelectParticipantModal();
            }
        });

        document.getElementById('confirm-select-btn').addEventListener('click', () => {
            const participantId = document.getElementById('participant-select').value;
            if (!participantId) {
                showToast("Por favor selecciona un participante.", "error");
                return;
            }
            generatePersonalInvite(participantId);
            closeSelectParticipantModal();
        });

        // Edit Participant Modal handlers
        document.getElementById('close-edit-modal-btn').addEventListener('click', () => {
            closeEditParticipantModal();
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            closeEditParticipantModal();
        });

        document.getElementById('edit-participant-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-participant-modal') {
                closeEditParticipantModal();
            }
        });

        // Checkbox credential toggle
        document.getElementById('enable-credentials').addEventListener('change', (e) => {
            const credentialsSection = document.getElementById('credentials-section');
            if (e.target.checked) {
                credentialsSection.classList.remove('hidden');
                document.getElementById('username').required = true;
                document.getElementById('password-input').required = true;
            } else {
                credentialsSection.classList.add('hidden');
                document.getElementById('username').required = false;
                document.getElementById('password-input').required = false;
            }
        });

        // Participant form handler
        document.getElementById('participant-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const enableCredentials = document.getElementById('enable-credentials').checked;
            
            const participantData = {
                id: generateId(),
                name: formData.get('name').trim(),
                email: formData.get('email').trim() || '',
                phone: formData.get('phone').trim(),
                username: enableCredentials ? formData.get('username').trim() : '',
                password: enableCredentials ? formData.get('password').trim() : '',
                assignedTo: '',
                assignedToEmail: '',
                drawId: currentDrawId,
                createdAt: new Date().toISOString(),
                recordType: 'participant',
                person1Id: '',
                person2Id: '',
                drawName: '',
                drawDate: ''
            };
            
            if (enableCredentials && participantData.username) {
                const allParticipants = allRecords.filter(r => r.recordType === 'participant');
                if (allParticipants.some(p => p.username === participantData.username)) {
                    showToast("Este nombre de usuario ya est√° en uso.", "error");
                    return;
                }
            }
            
            if (allRecords.length >= 999) {
                showToast("L√≠mite de 999 registros alcanzado. Por favor elimina algunos registros primero.", "error");
                return;
            }
            
            const saveBtn = document.getElementById('save-participant-btn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="spinner"></div><span>Guardando...</span></div>';
            
            const result = await window.dataSdk.create(participantData);
            
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
            
            if (result.isOk) {
                closeAddParticipantModal();
                showToast("Participante agregado exitosamente.", "success");
                document.getElementById('participant-form').reset();
            } else {
                showToast("Error al guardar el participante. Intenta nuevamente.", "error");
            }
        });

        // Edit participant form handler
        document.getElementById('edit-participant-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!editingParticipant) return;
            
            const formData = new FormData(e.target);
            const updatedData = {
                ...editingParticipant,
                name: formData.get('edit-name').trim(),
                email: formData.get('edit-email').trim(),
                phone: formData.get('edit-phone').trim(),
                username: formData.get('edit-username').trim(),
                password: formData.get('edit-password').trim()
            };
            
            // Only check for duplicate username if username field is not empty
            if (updatedData.username) {
                const allParticipants = allRecords.filter(r => r.recordType === 'participant');
                if (allParticipants.some(p => p.username === updatedData.username && p.__backendId !== editingParticipant.__backendId)) {
                    showToast("Este nombre de usuario ya est√° en uso.", "error");
                    return;
                }
            }
            
            const updateBtn = document.getElementById('update-participant-btn');
            const originalContent = updateBtn.innerHTML;
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="spinner"></div><span>Actualizando...</span></div>';
            
            const result = await window.dataSdk.update(updatedData);
            
            updateBtn.disabled = false;
            updateBtn.innerHTML = originalContent;
            
            if (result.isOk) {
                closeEditParticipantModal();
                showToast("Participante actualizado exitosamente.", "success");
            } else {
                showToast("Error al actualizar el participante. Intenta nuevamente.", "error");
            }
        });

        // Modal open/close functions
        function openAddParticipantModal() {
            document.getElementById('add-participant-modal').classList.remove('hidden');
        }

        function closeAddParticipantModal() {
            document.getElementById('add-participant-modal').classList.add('hidden');
            document.getElementById('participant-form').reset();
            document.getElementById('credentials-section').classList.add('hidden');
            document.getElementById('enable-credentials').checked = false;
            document.getElementById('username').required = false;
            document.getElementById('password-input').required = false;
        }

        function openRestrictionsModal() {
            updateRestrictionsSelects();
            renderRestrictionsList();
            document.getElementById('restrictions-modal').classList.remove('hidden');
        }

        function closeRestrictionsModal() {
            document.getElementById('restrictions-modal').classList.add('hidden');
        }

        function openSelectParticipantModal() {
            const select = document.getElementById('participant-select');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                select.appendChild(option);
            });
            
            document.getElementById('select-participant-modal').classList.remove('hidden');
        }

        function closeSelectParticipantModal() {
            document.getElementById('select-participant-modal').classList.add('hidden');
            document.getElementById('participant-select').value = '';
        }

        function openEditParticipantModal() {
            document.getElementById('edit-participant-modal').classList.remove('hidden');
        }

        function closeEditParticipantModal() {
            document.getElementById('edit-participant-modal').classList.add('hidden');
            document.getElementById('edit-participant-form').reset();
            editingParticipant = null;
        }

        // Show confirmation modal
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4';
            modal.style.zIndex = '2000';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl fade-in">
                    <div class="text-center mb-6">
                        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600">${message}</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="modal-cancel" 
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button id="modal-confirm" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#modal-cancel').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('#modal-confirm').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show toast message
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            toast.style.zIndex = '3000';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Create sinusoidal garland
        function createGarland() {
            const garlandStrand = document.getElementById('garland-strand');
            garlandStrand.innerHTML = '';
            const width = window.innerWidth;
            const numBranches = Math.floor(width / 25);
            const amplitude = 45;
            const frequency = 3;
            
            const colors = ['red', 'yellow', 'blue', 'green', 'pink', 'orange'];
            
            for (let i = 0; i < numBranches; i++) {
                const x = (i / numBranches) * width;
                const normalizedX = (i / numBranches) * Math.PI * 2 * frequency;
                const y = Math.sin(normalizedX) * amplitude + amplitude + 20;
                
                const branch = document.createElement('div');
                branch.className = 'garland-branch';
                branch.style.left = `${x}px`;
                branch.style.top = `${y}px`;
                branch.style.height = `${15 + Math.random() * 10}px`;
                branch.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                
                garlandStrand.appendChild(branch);
                
                if (i % 2 === 0) {
                    const light = document.createElement('div');
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    light.className = `light ${randomColor}`;
                    light.style.left = `${x}px`;
                    light.style.top = `${y + 22}px`;
                    
                    garlandStrand.appendChild(light);
                }
            }
        }

        // Element SDK Configuration
        async function onConfigChange(config) {
            document.getElementById('admin-title').textContent = config.admin_title || defaultConfig.admin_title;
            document.getElementById('participant-title').textContent = config.participant_title || defaultConfig.participant_title;
            document.getElementById('admin-event-name').textContent = config.event_name || defaultConfig.event_name;
            document.getElementById('participant-event-name').textContent = config.event_name || defaultConfig.event_name;
            document.getElementById('admin-welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('participant-welcome').textContent = config.participant_welcome || defaultConfig.participant_welcome;
            document.getElementById('admin-security-code-label').textContent = config.security_code_label || defaultConfig.security_code_label;
            
            const backgroundColor = config.background_color || defaultConfig.background_color;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            
            document.body.style.background = `linear-gradient(to bottom right, ${backgroundColor}, #fef3c7)`;
            
            const headers = document.querySelectorAll('header');
            headers.forEach(header => {
                if (header.closest('#admin-mode')) {
                    header.style.background = `linear-gradient(to right, ${primaryColor}, ${secondaryColor})`;
                }
            });
            
            const adminCard = document.querySelector('.admin-card');
            if (adminCard) {
                adminCard.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
            }
            
            const textElements = document.querySelectorAll('h1, h2, h3, h4, p, label');
            textElements.forEach(el => {
                if (!el.classList.contains('text-white') && !el.classList.contains('text-gray-300')) {
                    el.style.color = textColor;
                }
            });
            
            const surfaces = document.querySelectorAll('.bg-white');
            surfaces.forEach(surface => {
                surface.style.backgroundColor = surfaceColor;
            });
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            config.background_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.surface_color || defaultConfig.surface_color,
                        set: (value) => {
                            config.surface_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ surface_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.secondary_color || defaultConfig.secondary_color,
                        set: (value) => {
                            config.secondary_color = value;
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["admin_title", config.admin_title || defaultConfig.admin_title],
                ["participant_title", config.participant_title || defaultConfig.participant_title],
                ["event_name", config.event_name || defaultConfig.event_name],
                ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                ["participant_welcome", config.participant_welcome || defaultConfig.participant_welcome],
                ["security_code_label", config.security_code_label || defaultConfig.security_code_label]
            ]);
        }

        // Initialize SDKs
        async function initializeApp() {
            createGarland();
            initializeMode();
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
            
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Failed to initialize Data SDK");
                }
            }
        }
        
        window.addEventListener('resize', () => {
            const garlandStrand = document.getElementById('garland-strand');
            garlandStrand.innerHTML = '';
            createGarland();
        });

        initializeApp();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a29406261d4c2a3',t:'MTc2MzgyMzE1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
